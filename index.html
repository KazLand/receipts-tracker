<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipts Tracker</title>
  <meta name="description" content="Simple mobile receipts tracker - add receipts, see totals, export CSV/PDF" />
  <!-- Fonts (system fallback) -->
  <style>
    :root{
      --bg:#f7f9fb;
      --card:#ffffff;
      --accent:#0ea5a4;
      --muted:#6b7280;
      --danger:#ef4444;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}
    body{background:linear-gradient(180deg,var(--bg),#eef2f7);padding:12px;color:#0f172a}
    .app{max-width:820px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .subtitle{font-size:12px;color:var(--muted)}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;box-shadow:0 6px 18px rgba(15,23,42,.06);margin-bottom:12px}
    form.row{display:flex;gap:8px;align-items:center}
    input,select,button,textarea{padding:10px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px}
    input[type="date"]{padding:8px}
    input[type="number"]{max-width:150px}
    .btn{background:var(--accent);color:white;border:none;cursor:pointer;padding:10px 12px;border-radius:10px}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(14,165,164,.16)}
    .totals{display:flex;gap:8px;flex-wrap:wrap}
    .total-pill{flex:1;min-width:120px;padding:10px;border-radius:10px;background:#fafcff;text-align:center}
    .list{margin-top:10px}
    .item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:10px;border-radius:10px;border:1px solid #f0f3f8;margin-bottom:8px}
    .meta{display:flex;flex-direction:column}
    .muted{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:6px}
    .small{font-size:13px;padding:6px 8px}
    .danger{background:var(--danger);color:white;border:none}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    @media(min-width:700px){
      h1{font-size:20px}
      .card{padding:16px}
    }
  </style>
  <!-- jsPDF + autoTable for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Receipts Tracker</h1>
        <div class="subtitle">Add daily receipts — export monthly report</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:12px;color:var(--muted)">Device storage</div>
        <div style="font-weight:700">Local (no server)</div>
      </div>
    </header>

    <!-- Add receipt card -->
    <section class="card">
      <form id="receiptForm" class="row" onsubmit="return false;">
        <input id="date" type="date" required />
        <input id="description" type="text" placeholder="Description (e.g., Taxi)" style="flex:1" />
        <input id="amount" type="number" step="0.01" placeholder="Amount" required />
        <button id="addBtn" class="btn small">Add</button>
      </form>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
        <button id="exportCsv" class="btn small">Export CSV</button>
        <button id="exportPdf" class="btn small">Export PDF</button>
        <button id="backup" class="btn ghost small">Backup (JSON)</button>
        <button id="restore" class="btn ghost small">Restore</button>
        <button id="clearAll" class="small danger">Clear All</button>
      </div>
    </section>

    <!-- Totals -->
    <section class="card totals">
      <div class="total-pill">
        <div class="muted">Today</div>
        <div id="totalToday" style="font-weight:700;font-size:16px">$0.00</div>
      </div>
      <div class="total-pill">
        <div class="muted">Month</div>
        <div id="totalMonth" style="font-weight:700;font-size:16px">$0.00</div>
      </div>
      <div class="total-pill">
        <div class="muted">Year</div>
        <div id="totalYear" style="font-weight:700;font-size:16px">$0.00</div>
      </div>
    </section>

    <!-- Filters / summary sheet -->
    <section class="card">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <label class="muted">Filter month</label>
        <select id="filterMonth"></select>
        <label class="muted">Year</label>
        <select id="filterYear"></select>
        <button id="applyFilter" class="btn small">Apply</button>
        <button id="resetFilter" class="btn ghost small">Reset</button>
      </div>

      <div class="list" id="list"></div>
    </section>

    <footer class="muted">
      Tip: Save to Home Screen for quick access. Data stays on the phone browser.
    </footer>
  </div>

  <script>
  (() => {
    // Utilities
    const $ = id => document.getElementById(id);
    const STORAGE_KEY = "receipts_tracker_v1";

    // Elements
    const dateInput = $('date');
    const descInput = $('description');
    const amountInput = $('amount');
    const addBtn = $('addBtn');
    const listEl = $('list');
    const totalTodayEl = $('totalToday');
    const totalMonthEl = $('totalMonth');
    const totalYearEl = $('totalYear');
    const exportCsvBtn = $('exportCsv');
    const exportPdfBtn = $('exportPdf');
    const backupBtn = $('backup');
    const restoreBtn = $('restore');
    const clearAllBtn = $('clearAll');
    const filterMonth = $('filterMonth');
    const filterYear = $('filterYear');
    const applyFilter = $('applyFilter');
    const resetFilter = $('resetFilter');

    // State
    let receipts = [];
    let filter = { month: null, year: null };

    // Init date to today
    function setToday() {
      const today = new Date();
      const y = today.getFullYear();
      const m = (today.getMonth()+1).toString().padStart(2,'0');
      const d = today.getDate().toString().padStart(2,'0');
      dateInput.value = `${y}-${m}-${d}`;
    }

    // Load / Save
    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(receipts));
    }
    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      receipts = raw ? JSON.parse(raw) : [];
    }

    // ID generator
    function uid(){ return 'r'+Date.now().toString(36)+Math.random().toString(36).slice(2,6); }

    // Add receipt
    function addReceipt(date, description, amount){
      const r = { id: uid(), date, description: description||"", amount: Number(amount) };
      receipts.push(r);
      save();
      render();
    }

    // Update receipt
    function updateReceipt(id, fields){
      const i = receipts.findIndex(x=>x.id===id);
      if(i>=0){
        receipts[i]=Object.assign({}, receipts[i], fields);
        save();
        render();
      }
    }

    // Delete
    function deleteReceipt(id){
      if(!confirm("Delete this receipt?")) return;
      receipts = receipts.filter(r=>r.id!==id);
      save();
      render();
    }

    // Clear
    clearAllBtn.addEventListener('click', () => {
      if(!confirm("Clear ALL receipts? This cannot be undone.")) return;
      receipts = [];
      save();
      render();
    });

    // Render list + totals
    function render(){
      // Sort newest first
      receipts.sort((a,b)=> new Date(b.date) - new Date(a.date));
      // Apply filter
      let shown = receipts;
      if(filter.month!==null && filter.year!==null){
        shown = receipts.filter(r=>{
          const d = new Date(r.date);
          return d.getMonth()+1 === filter.month && d.getFullYear() === filter.year;
        });
      }

      // Render items
      listEl.innerHTML = "";
      if(shown.length===0){
        listEl.innerHTML = '<div class="muted" style="padding:8px">No receipts yet.</div>';
      } else {
        for(const r of shown){
          const item = document.createElement('div'); item.className='item';
          const left = document.createElement('div'); left.className='meta';
          const d = new Date(r.date);
          const dateStr = d.toLocaleDateString();
          left.innerHTML = `<div style="font-weight:700">${r.description||'—'}</div><div class="muted">${dateStr}</div>`;
          const right = document.createElement('div');
          right.style.display='flex'; right.style.alignItems='center'; right.style.gap='8px';
          const amt = document.createElement('div'); amt.style.fontWeight='700'; amt.textContent = formatCurrency(r.amount);
          const actions = document.createElement('div'); actions.className='actions';
          const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Edit';
          editBtn.addEventListener('click', ()=> openEditDialog(r));
          const delBtn = document.createElement('button'); delBtn.className='small'; delBtn.style.background='#fff'; delBtn.style.border='1px solid #f0f0f0'; delBtn.textContent='Delete';
          delBtn.addEventListener('click', ()=> deleteReceipt(r.id));
          actions.appendChild(editBtn); actions.appendChild(delBtn);
          right.appendChild(amt); right.appendChild(actions);
          item.appendChild(left); item.appendChild(right);
          listEl.appendChild(item);
        }
      }

      updateTotals();
    }

    // Totals
    function updateTotals(){
      const now = new Date();
      const todayStr = dateOnly(now);
      let totalToday = 0, totalMonth = 0, totalYear = 0;
      for(const r of receipts){
        const d = new Date(r.date);
        if(dateOnly(d) === todayStr) totalToday += r.amount;
        if(d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) totalMonth += r.amount;
        if(d.getFullYear() === now.getFullYear()) totalYear += r.amount;
      }
      totalTodayEl.textContent = formatCurrency(totalToday);
      totalMonthEl.textContent = formatCurrency(totalMonth);
      totalYearEl.textContent = formatCurrency(totalYear);
    }

    // Helpers
    function dateOnly(d){
      return `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
    }
    function formatCurrency(v){
      return (typeof Intl !== "undefined") ? new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(v) : '$'+v.toFixed(2);
    }

    // Form submit
    addBtn.addEventListener('click', ()=>{
      const date = dateInput.value;
      const desc = descInput.value.trim();
      const amt = parseFloat(amountInput.value);
      if(!date || !Number.isFinite(amt)){ alert("Please provide date and valid amount."); return; }
      addReceipt(date, desc, amt);
      // reset description and amount, keep date as today
      descInput.value=''; amountInput.value='';
      setToday();
    });

    // Edit dialog (simple prompt-based)
    function openEditDialog(r){
      const newDesc = prompt("Description:", r.description);
      if(newDesc===null) return;
      const newDate = prompt("Date (YYYY-MM-DD):", r.date);
      if(newDate===null) return;
      const newAmtRaw = prompt("Amount:", r.amount);
      if(newAmtRaw===null) return;
      const newAmt = Number(newAmtRaw);
      if(!newDate || !Number.isFinite(newAmt)){ alert("Invalid input."); return; }
      updateReceipt(r.id, { description: newDesc, date: newDate, amount: newAmt });
    }

    // Export CSV
    function exportCSV(filteredOnly=true){
      const rows = (filter.month!==null && filter.year!==null && filteredOnly) ? receipts.filter(r=>{
        const d = new Date(r.date);
        return d.getMonth()+1 === filter.month && d.getFullYear() === filter.year;
      }) : receipts;
      if(rows.length===0){ alert("No receipts to export."); return; }
      let csv = 'Date,Description,Amount\n';
      rows.forEach(r => {
        const d = r.date;
        const desc = (r.description||'').replace(/"/g,'""');
        csv += `"${d}","${desc}",${r.amount}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `receipts_${Date.now()}.csv`; a.style.display='none';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
    exportCsvBtn.addEventListener('click', ()=> exportCSV(true));

    // Export PDF (uses jsPDF + autotable)
    async function exportPDF(filteredOnly=true){
      const { jsPDF } = window.jspdf;
      const rows = (filter.month!==null && filter.year!==null && filteredOnly) ? receipts.filter(r=>{
        const d = new Date(r.date);
        return d.getMonth()+1 === filter.month && d.getFullYear() === filter.year;
      }) : receipts;
      if(rows.length===0){ alert("No receipts to export."); return; }
      const doc = new jsPDF({unit:'pt',format:'a4'});
      const title = 'Receipts Report';
      const now = new Date();
      doc.setFontSize(14); doc.text(title, 40, 40);
      doc.setFontSize(10); doc.text(`Generated: ${now.toLocaleString()}`, 40, 58);
      // totals
      let sum=0; rows.forEach(r=> sum+=r.amount);
      doc.text(`Total: ${formatCurrency(sum)}`, 40, 76);
      // table
      const table = rows.map(r => {
        return [r.date, r.description||'', formatCurrency(r.amount)];
      });
      doc.autoTable({
        startY: 96,
        head: [['Date','Description','Amount']],
        body: table,
        styles: { fontSize:10 },
        headStyles: { fillColor: [14,165,164] }
      });
      doc.save(`receipts_${Date.now()}.pdf`);
    }
    exportPdfBtn.addEventListener('click', ()=> exportPDF(true));

    // Backup JSON
    backupBtn.addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(receipts, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = `receipts_backup_${Date.now()}.json`; a.style.display='none';
      document.body.appendChild(a); a.click(); a.remove();
    });

    // Restore (upload JSON)
    restoreBtn.addEventListener('click', ()=>{
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = evt => {
        const file = evt.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = JSON.parse(e.target.result);
            if(!Array.isArray(data)) throw new Error("Invalid backup format");
            // simple validation
            for(const r of data) {
              if(!r.id) r.id = uid();
              r.amount = Number(r.amount) || 0;
            }
            if(!confirm("Restore backup and overwrite current data?")) return;
            receipts = data;
            save();
            render();
            alert("Restore complete.");
          } catch(err){
            alert("Invalid file: " + err.message);
          }
        };
        reader.readAsText(file);
      };
      inp.click();
    });

    // Filters populate
    function populateFilterControls(){
      // Month options
      const months = ['All','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      filterMonth.innerHTML='';
      for(let i=0;i<months.length;i++){
        const opt = document.createElement('option'); opt.value = i; opt.textContent = months[i];
        filterMonth.appendChild(opt);
      }
      // Year (last 5 years + current + next 1)
      const now = new Date();
      const cur = now.getFullYear();
      filterYear.innerHTML='';
      const allOpt = document.createElement('option'); allOpt.value='all'; allOpt.textContent='All'; filterYear.appendChild(allOpt);
      for(let y=cur+1; y>=cur-5; y--){
        const opt = document.createElement('option'); opt.value = y; opt.textContent = y; filterYear.appendChild(opt);
      }
      resetFilterControls();
    }
    function resetFilterControls(){
      filterMonth.value = '0';
      filterYear.value = 'all';
      filter = { month: null, year: null };
    }
    applyFilter.addEventListener('click', ()=>{
      const m = Number(filterMonth.value);
      const y = filterYear.value === 'all' ? null : Number(filterYear.value);
      if(y===null || filterMonth.value==='0'){
        alert("Select both month and year to filter (or use Reset).");
        return;
      }
      filter = { month: m, year: y };
      // convert to numeric month
      filter.month = m;
      filter.year = y;
      // If month value '0' is All in our control, but UI used 0 as All earlier; guard
      if(filter.month === 0){ alert("Choose a numerical month, not 'All'"); return; }
      render();
    });
    resetFilter.addEventListener('click', ()=>{
      resetFilterControls();
      render();
    });

    // CSV & PDF export for entire dataset if user wants (you can modify)
    // We exported with filter by default (filteredOnly=true)

    // Init
    function init(){
      setToday();
      load();
      populateFilterControls();
      render();
      // friendly keyboard on mobile
      amountInput.setAttribute('inputmode','decimal');
    }
    init();

    // Accessibility: keyboard add on Enter in amount field
    amountInput.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') addBtn.click();
    });
  })();
  </script>
</body>
</html>
